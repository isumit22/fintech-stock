<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Professional Fintech Predictor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: white;
            overflow-x: auto;
        }

        .main-container {
            max-width: 100%;
            padding: 20px;
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00f5ff, #ff00ff, #ffff00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: glow 3s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: brightness(1); }
            to { filter: brightness(1.2); }
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 25px;
            font-weight: 300;
        }

        .feature-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .feature-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .feature-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .dashboard-layout {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .panel h3 {
            color: #00f5ff;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .market-selector {
            margin-bottom: 25px;
        }

        .selector-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 15px;
        }

        .selector-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .selector-tab.active {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            color: white;
        }

        .selector-tab:not(.active):hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .symbol-select {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .symbol-select:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .symbol-select option {
            background: #2a2a3e;
            color: white;
        }

        .price-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        }

        .price-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .price-value {
            font-size: 4.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .price-details {
            position: relative;
            z-index: 1;
        }

        .price-symbol {
            font-size: 1.6rem;
            opacity: 0.95;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .price-change {
            font-size: 1.3rem;
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 25px;
            display: inline-block;
        }

        .price-change.positive { 
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .price-change.negative { 
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b; 
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .price-change.neutral { 
            background: rgba(254, 202, 87, 0.2);
            color: #feca57; 
            border: 1px solid rgba(254, 202, 87, 0.3);
        }

        .chart-container {
            height: 500px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .chart-btn:hover, .chart-btn.active {
            background: linear-gradient(45deg, #00f5ff, #ff00ff);
            border-color: transparent;
        }

        .prediction-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid;
        }

        .prediction-section.bullish { border-left-color: #00ff88; }
        .prediction-section.bearish { border-left-color: #ff6b6b; }
        .prediction-section.neutral { border-left-color: #feca57; }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .prediction-trend {
            font-size: 2.2rem;
            font-weight: 900;
            text-transform: uppercase;
        }

        .prediction-trend.bullish { 
            color: #00ff88; 
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.3); 
        }
        
        .prediction-trend.bearish { 
            color: #ff6b6b; 
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3); 
        }
        
        .prediction-trend.neutral { 
            color: #feca57; 
            text-shadow: 0 0 10px rgba(254, 202, 87, 0.3); 
        }

        .confidence-display {
            text-align: center;
        }

        .confidence-value {
            font-size: 3rem;
            font-weight: 900;
            color: #00f5ff;
            text-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        .confidence-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .confidence-bar-wrapper {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .confidence-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #feca57 50%, #00ff88 100%);
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 10px;
        }

        .confidence-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: confidence-pulse 2s infinite;
        }

        @keyframes confidence-pulse {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .technical-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .indicator-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .indicator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(0,245,255,0.1), rgba(255,0,255,0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .indicator-card:hover::before {
            opacity: 1;
        }

        .indicator-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .indicator-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .indicator-value {
            font-size: 1.6rem;
            font-weight: 900;
            color: #00f5ff;
            position: relative;
            z-index: 1;
        }

        .timeframe-analysis {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .timeframe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .timeframe-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .timeframe-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .timeframe-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .timeframe-trend {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .timeframe-trend.bullish { color: #00ff88; }
        .timeframe-trend.bearish { color: #ff6b6b; }
        .timeframe-trend.neutral { color: #feca57; }

        .crypto-section, .forex-section, .commodity-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .market-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .market-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .market-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00f5ff;
        }

        .market-price {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .market-change {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .export-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .export-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff6b6b;
        }

        .status-dot.connected { 
            background: #00ff88; 
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .heatmap-container {
            height: 300px;
            margin-bottom: 20px;
        }

        .analysis-reasoning {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            font-size: 1rem;
            line-height: 1.6;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 1400px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
                gap: 25px;
            }
        }

        @media (max-width: 768px) {
            .main-title {
                font-size: 2.5rem;
            }
            
            .price-value {
                font-size: 3.5rem;
            }
            
            .chart-controls {
                justify-content: center;
            }
            
            .feature-badges {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Enhanced Header -->
        <div class="header-section">
            <div class="main-title">ENHANCED FINTECH PREDICTOR</div>
            <div class="subtitle">Professional-grade analysis with interactive charts, crypto tracking, and advanced indicators</div>
            <div class="feature-badges">
                <div class="feature-badge">üìà Interactive Charts</div>
                <div class="feature-badge">üöÄ Crypto Analysis</div>
                <div class="feature-badge">üìä Advanced Indicators</div>
                <div class="feature-badge">üåê Global Markets</div>
                <div class="feature-badge">üìÑ PDF Reports</div>
            </div>
        </div>

        <!-- Main Dashboard Layout -->
        <div class="dashboard-layout">
            <!-- Left Panel: Market Selection & Technical Indicators -->
            <div class="panel">
                <h3><i class="fas fa-chart-line"></i> Market Selection</h3>
                <div class="market-selector">
                    <div class="selector-tabs">
                        <div class="selector-tab active" data-market="stocks">Stocks</div>
                        <div class="selector-tab" data-market="crypto">Crypto</div>
                        <div class="selector-tab" data-market="forex">Forex</div>
                        <div class="selector-tab" data-market="commodities">Commodities</div>
                    </div>
                    <select class="symbol-select" id="symbol-select">
                        {% for symbol, name in stocks.items() %}
                        <option value="{{ symbol }}" {% if symbol == current_stock %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <h3><i class="fas fa-cogs"></i> Technical Indicators</h3>
                <div class="technical-grid">
                    <div class="indicator-card">
                        <div class="indicator-label">RSI</div>
                        <div class="indicator-value" id="rsi-value">--</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">MACD</div>
                        <div class="indicator-value" id="macd-value">--</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">Volatility</div>
                        <div class="indicator-value" id="volatility-value">--</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">ATR</div>
                        <div class="indicator-value" id="atr-value">--</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">Stoch %K</div>
                        <div class="indicator-value" id="stoch-k-value">--</div>
                    </div>
                    <div class="indicator-card">
                        <div class="indicator-label">Williams %R</div>
                        <div class="indicator-value" id="williams-r-value">--</div>
                    </div>
                </div>

                <h3><i class="fas fa-download"></i> Export Reports</h3>
                <div class="export-section">
                    <button class="export-btn" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="export-btn" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>

            <!-- Center Panel: Price Display & Interactive Chart -->
            <div class="panel">
                <div class="price-display">
                    <div class="price-value" id="price-display">$0.00</div>
                    <div class="price-details">
                        <div class="price-symbol" id="symbol-display">Loading...</div>
                        <div class="price-change neutral" id="price-change">--</div>
                    </div>
                </div>

                <div class="prediction-section neutral" id="prediction-section">
                    <div class="prediction-header">
                        <div class="prediction-trend neutral" id="prediction-trend">ANALYZING...</div>
                        <div class="confidence-display">
                            <div class="confidence-value" id="confidence-value">0%</div>
                            <div class="confidence-label">Confidence</div>
                        </div>
                    </div>
                    <div class="confidence-bar-wrapper">
                        <div class="confidence-bar" id="confidence-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-controls">
                        <button class="chart-btn active" data-timeframe="1d">1D</button>
                        <button class="chart-btn" data-timeframe="5d">5D</button>
                        <button class="chart-btn" data-timeframe="1mo">1M</button>
                        <button class="chart-btn" data-timeframe="3mo">3M</button>
                        <button class="chart-btn" data-timeframe="6mo">6M</button>
                        <button class="chart-btn" data-timeframe="1y">1Y</button>
                        <button class="chart-btn" data-indicator="sma">SMA</button>
                        <button class="chart-btn" data-indicator="bollinger">Bollinger</button>
                        <button class="chart-btn" data-indicator="fibonacci">Fibonacci</button>
                    </div>
                    <div id="interactive-chart"></div>
                </div>

                <div class="analysis-reasoning" id="analysis-reasoning">
                    Initializing enhanced analysis engine with advanced technical indicators...
                </div>
            </div>

            <!-- Right Panel: Multi-timeframe & Market Overview -->
            <div class="panel">
                <h3><i class="fas fa-clock"></i> Multi-timeframe Analysis</h3>
                <div class="timeframe-analysis">
                    <div class="timeframe-grid" id="timeframe-grid">
                        <!-- Timeframe data will be populated here -->
                    </div>
                </div>

                <h3><i class="fas fa-bitcoin"></i> Cryptocurrency Market</h3>
                <div class="crypto-section">
                    <div class="market-grid" id="crypto-grid">
                        <!-- Crypto data will be populated here -->
                    </div>
                </div>

                <h3><i class="fas fa-exchange-alt"></i> Forex Market</h3>
                <div class="forex-section">
                    <div class="market-grid" id="forex-grid">
                        <!-- Forex data will be populated here -->
                    </div>
                </div>

                <h3><i class="fas fa-coins"></i> Commodities</h3>
                <div class="commodity-section">
                    <div class="market-grid" id="commodity-grid">
                        <!-- Commodity data will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Heatmap Section -->
        <div class="panel">
            <h3><i class="fas fa-fire"></i> Market Heatmap</h3>
            <div class="heatmap-container" id="market-heatmap"></div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="websocket-status"></div>
                <span id="websocket-text">WebSocket</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="analysis-status"></div>
                <span>Analysis Engine</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="crypto-status"></div>
                <span>Crypto Data</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="chart-status"></div>
                <span>Interactive Charts</span>
            </div>
        </div>
    </div>

    <script>
        // Enhanced WebSocket client with advanced features
        const socket = io();
        let currentSymbol = '{{ current_stock }}';
        let currentTimeframe = '1d';
        let currentMarket = 'stocks';
        
        // Market data storage
        const marketData = {
            stocks: {{ stocks | tojsonfilter }},
            crypto: {
                'BTC-USD': 'Bitcoin',
                'ETH-USD': 'Ethereum',
                'BNB-USD': 'Binance Coin',
                'XRP-USD': 'Ripple',
                'ADA-USD': 'Cardano'
            },
            forex: {
                'EURUSD=X': 'EUR/USD',
                'GBPUSD=X': 'GBP/USD',
                'USDJPY=X': 'USD/JPY',
                'USDCHF=X': 'USD/CHF'
            },
            commodities: {
                'GC=F': 'Gold Futures',
                'SI=F': 'Silver Futures',
                'CL=F': 'Crude Oil',
                'NG=F': 'Natural Gas'
            }
        };

        // DOM elements
        const priceDisplay = document.getElementById('price-display');
        const symbolDisplay = document.getElementById('symbol-display');
        const priceChange = document.getElementById('price-change');
        const predictionTrend = document.getElementById('prediction-trend');
        const predictionSection = document.getElementById('prediction-section');
        const confidenceValue = document.getElementById('confidence-value');
        const confidenceBar = document.getElementById('confidence-bar');
        const analysisReasoning = document.getElementById('analysis-reasoning');
        const symbolSelect = document.getElementById('symbol-select');

        // Technical indicator elements
        const rsiValue = document.getElementById('rsi-value');
        const macdValue = document.getElementById('macd-value');
        const volatilityValue = document.getElementById('volatility-value');
        const atrValue = document.getElementById('atr-value');
        const stochKValue = document.getElementById('stoch-k-value');
        const williamsRValue = document.getElementById('williams-r-value');

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', () => {
            initializeMarketTabs();
            initializeChartControls();
            loadInteractiveChart();
            requestMarketUpdate();
            
            // Set intervals for different data types
            setInterval(requestMarketUpdate, 10000); // Main analysis every 10s
            setInterval(updateCryptoData, 30000);    // Crypto every 30s
            setInterval(updateMarketHeatmap, 60000); // Heatmap every minute
        });

        // WebSocket event handlers
        socket.on('connect', () => {
            updateStatus('websocket-status', true, 'Connected');
            updateStatus('analysis-status', true, 'Active');
            updateStatus('crypto-status', true, 'Live');
            updateStatus('chart-status', true, 'Ready');
        });

        socket.on('disconnect', () => {
            updateStatus('websocket-status', false, 'Disconnected');
            updateStatus('analysis-status', false, 'Offline');
            updateStatus('crypto-status', false, 'Offline');
            updateStatus('chart-status', false, 'Offline');
        });

        socket.on('comprehensive_market_update', (data) => {
            updateMainDashboard(data);
            updateTimeframeAnalysis(data.analysis.timeframe_analysis);
            if (data.market_overview) {
                updateMarketOverview(data.market_overview);
            }
        });

        // Market tab functionality
        function initializeMarketTabs() {
            const tabs = document.querySelectorAll('.selector-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMarket = tab.dataset.market;
                    updateSymbolSelect(currentMarket);
                });
            });
        }

        function updateSymbolSelect(market) {
            const select = document.getElementById('symbol-select');
            select.innerHTML = '';
            
            const symbols = marketData[market] || marketData.stocks;
            Object.entries(symbols).forEach(([symbol, name]) => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = name;
                select.appendChild(option);
            });
            
            if (select.children.length > 0) {
                currentSymbol = select.children[0].value;
                select.value = currentSymbol;
                changeSymbol();
            }
        }

        // Chart controls initialization
        function initializeChartControls() {
            const controls = document.querySelectorAll('.chart-btn');
            controls.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.timeframe) {
                        // Handle timeframe buttons
                        document.querySelectorAll('[data-timeframe]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentTimeframe = btn.dataset.timeframe;
                        loadInteractiveChart();
                    } else if (btn.dataset.indicator) {
                        // Handle indicator buttons
                        btn.classList.toggle('active');
                        loadInteractiveChart();
                    }
                });
            });
        }

        // Symbol change handler
        symbolSelect.addEventListener('change', () => {
            currentSymbol = symbolSelect.value;
            changeSymbol();
        });

        function changeSymbol() {
            fetch('/change_stock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock: currentSymbol })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadInteractiveChart();
                    requestMarketUpdate();
                }
            })
            .catch(error => console.error('Error changing symbol:', error));
        }

        // Update main dashboard
        function updateMainDashboard(data) {
            const analysis = data.analysis;
            
            // Update price display
            const price = analysis.current_price;
            const currency = currentSymbol.includes('-USD') || currentSymbol.includes('=X') ? '$' : '‚Çπ';
            priceDisplay.textContent = `${currency}${price.toFixed(2)}`;
            symbolDisplay.textContent = analysis.company_name;
            
            // Update price change
            const change = analysis.price_change;
            const changePercent = analysis.price_change_percent;
            const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
            
            priceChange.textContent = `${change > 0 ? '+' : ''}${currency}${change.toFixed(2)} (${changePercent > 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
            priceChange.className = `price-change ${changeClass}`;
            
            // Update prediction
            const prediction = analysis.prediction.toLowerCase();
            predictionTrend.textContent = analysis.prediction;
            predictionTrend.className = `prediction-trend ${prediction}`;
            predictionSection.className = `prediction-section ${prediction}`;
            
            // Update confidence
            const confidence = Math.round(analysis.confidence);
            confidenceValue.textContent = `${confidence}%`;
            confidenceBar.style.width = `${confidence}%`;
            
            // Update reasoning
            analysisReasoning.textContent = analysis.reasoning;
            
            // Update technical indicators
            const tech = analysis.technical_analysis;
            rsiValue.textContent = tech.rsi.toFixed(1);
            macdValue.textContent = tech.macd.toFixed(3);
            volatilityValue.textContent = tech.volatility.toFixed(1);
            atrValue.textContent = tech.atr.toFixed(2);
            stochKValue.textContent = tech.stochastic_k.toFixed(1);
            williamsRValue.textContent = tech.williams_r.toFixed(1);
        }

        // Load interactive chart
        function loadInteractiveChart() {
            fetch(`/api/chart/${currentSymbol}/${currentTimeframe}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderInteractiveChart(data.chart);
                    }
                })
                .catch(error => {
                    console.error('Chart loading error:', error);
                    document.getElementById('interactive-chart').innerHTML = 
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ff6b6b;">Chart loading failed</div>';
                });
        }

        // Render interactive chart using Plotly
        function renderInteractiveChart(chartData) {
            if (!chartData || !chartData.ohlcv || chartData.ohlcv.length === 0) {
                document.getElementById('interactive-chart').innerHTML = 
                    '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #feca57;">No chart data available</div>';
                return;
            }

            const traces = [];
            
            // Main candlestick chart
            const candlestick = {
                x: chartData.ohlcv.map(d => new Date(d.timestamp)),
                open: chartData.ohlcv.map(d => d.open),
                high: chartData.ohlcv.map(d => d.high),
                low: chartData.ohlcv.map(d => d.low),
                close: chartData.ohlcv.map(d => d.close),
                type: 'candlestick',
                name: currentSymbol,
                increasing: { line: { color: '#00ff88' } },
                decreasing: { line: { color: '#ff6b6b' } }
            };
            traces.push(candlestick);

            // Add indicators based on active buttons
            const activeIndicators = document.querySelectorAll('.chart-btn[data-indicator].active');
            activeIndicators.forEach(btn => {
                const indicator = btn.dataset.indicator;
                if (chartData.indicators && chartData.indicators[indicator]) {
                    // Add indicator traces
                    if (indicator === 'sma' && chartData.indicators.sma_20) {
                        traces.push({
                            x: chartData.indicators.sma_20.map(d => new Date(d.timestamp)),
                            y: chartData.indicators.sma_20.map(d => d.value),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'SMA 20',
                            line: { color: '#00f5ff', width: 2 }
                        });
                    }
                    
                    if (indicator === 'bollinger' && chartData.indicators.bollinger_upper) {
                        traces.push({
                            x: chartData.indicators.bollinger_upper.map(d => new Date(d.timestamp)),
                            y: chartData.indicators.bollinger_upper.map(d => d.value),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Upper',
                            line: { color: '#ff00ff', width: 1 }
                        });
                        
                        traces.push({
                            x: chartData.indicators.bollinger_lower.map(d => new Date(d.timestamp)),
                            y: chartData.indicators.bollinger_lower.map(d => d.value),
                            type: 'scatter',
                            mode: 'lines',
                            name: 'BB Lower',
                            line: { color: '#ff00ff', width: 1 }
                        });
                    }
                }
            });

            const layout = {
                title: {
                    text: `${currentSymbol} - ${currentTimeframe.toUpperCase()} Chart`,
                    font: { color: 'white', size: 16 }
                },
                xaxis: {
                    type: 'date',
                    gridcolor: 'rgba(255,255,255,0.1)',
                    color: 'white'
                },
                yaxis: {
                    gridcolor: 'rgba(255,255,255,0.1)',
                    color: 'white'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'white' },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    font: { color: 'white' }
                },
                margin: { l: 50, r: 50, t: 50, b: 50 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            };

            Plotly.newPlot('interactive-chart', traces, layout, config);
        }

        // Update timeframe analysis
        function updateTimeframeAnalysis(timeframeData) {
            const grid = document.getElementById('timeframe-grid');
            if (!timeframeData) return;
            
            grid.innerHTML = '';
            
            Object.entries(timeframeData).forEach(([timeframe, data]) => {
                const item = document.createElement('div');
                item.className = 'timeframe-item';
                
                const trendClass = data.trend.toLowerCase();
                
                item.innerHTML = `
                    <div class="timeframe-label">${timeframe.toUpperCase()}</div>
                    <div class="timeframe-trend ${trendClass}">${data.trend}</div>
                    <div style="font-size: 0.8rem; margin-top: 5px;">${data.change_percent.toFixed(2)}%</div>
                `;
                
                grid.appendChild(item);
            });
        }

        // Update market overview
        function updateMarketOverview(marketOverview) {
            if (marketOverview.crypto_summary) {
                updateMarketGrid('crypto-grid', marketOverview.crypto_summary);
            }
            // Add similar updates for forex and commodities
        }

        function updateMarketGrid(gridId, data) {
            const grid = document.getElementById(gridId);
            if (!grid || !data) return;
            
            grid.innerHTML = '';
            
            Object.entries(data).slice(0, 4).forEach(([symbol, info]) => {
                const item = document.createElement('div');
                item.className = 'market-item';
                item.style.cursor = 'pointer';
                
                const changeClass = info.change_24h > 0 ? 'positive' : 
                                  info.change_24h < 0 ? 'negative' : 'neutral';
                
                item.innerHTML = `
                    <div class="market-name">${info.name}</div>
                    <div class="market-price">$${info.price.toFixed(2)}</div>
                    <div class="market-change ${changeClass}">${info.change_24h.toFixed(2)}%</div>
                `;
                
                item.addEventListener('click', () => {
                    currentSymbol = symbol;
                    symbolSelect.value = symbol;
                    changeSymbol();
                });
                
                grid.appendChild(item);
            });
        }

        // Crypto data update
        function updateCryptoData() {
            fetch('/api/crypto_analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateMarketGrid('crypto-grid', data.crypto);
                    }
                })
                .catch(error => console.error('Crypto update error:', error));
        }

        // Market heatmap update
        function updateMarketHeatmap() {
            fetch('/api/market_heatmap')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderHeatmap(data.heatmap);
                    }
                })
                .catch(error => console.error('Heatmap update error:', error));
        }

        function renderHeatmap(heatmapData) {
            // Simplified heatmap rendering
            const container = document.getElementById('market-heatmap');
            if (!heatmapData || !container) return;
            
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #00f5ff;">Market Heatmap Loading...</div>';
            
            // In a real implementation, you'd use a library like D3.js or a specialized heatmap component
        }

        // Export functions
        function exportPDF() {
            window.open(`/api/export/pdf/${currentSymbol}`, '_blank');
        }

        function exportExcel() {
            window.open(`/api/export/excel/${currentSymbol}`, '_blank');
        }

        // Status update utility
        function updateStatus(elementId, connected, text) {
            const dot = document.getElementById(elementId);
            const textElement = document.getElementById(elementId.replace('-status', '-text'));
            
            if (dot) {
                dot.className = connected ? 'status-dot connected' : 'status-dot';
            }
            if (textElement) {
                textElement.textContent = text;
            }
        }

        // Check system status via HTTP
        function checkSystemStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateStatus('websocket-status', data.websocket, data.websocket ? 'Connected' : 'Disconnected');
                    updateStatus('analysis-status', data.analysis_engine, data.analysis_engine ? 'Active' : 'Offline');
                    updateStatus('crypto-status', data.crypto_data, data.crypto_data ? 'Live' : 'Offline');
                    updateStatus('chart-status', data.interactive_charts, data.interactive_charts ? 'Ready' : 'Offline');
                })
                .catch(error => {
                    console.warn('Status check failed:', error);
                    // Set all to offline if can't reach server
                    updateStatus('websocket-status', false, 'Disconnected');
                    updateStatus('analysis-status', false, 'Offline');
                    updateStatus('crypto-status', false, 'Offline');
                    updateStatus('chart-status', false, 'Offline');
                });
        }

        // Request market update
        function requestMarketUpdate() {
            socket.emit('request_market_update');
        }

        // Initialize dashboard
        setTimeout(() => {
            checkSystemStatus(); // Check status first
            requestMarketUpdate();
            updateCryptoData();
            updateMarketHeatmap();
        }, 2000);

        // Check status every 30 seconds
        setInterval(checkSystemStatus, 30000);
    </script>
</body>
</html>